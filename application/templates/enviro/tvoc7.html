<!DOCTYPE html>
{% load static %}


<html lang="en">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
<head>
    <title>IOT Plateforme</title>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=0.0">

    <meta name="description" content="Portal - Bootstrap 5 Admin Dashboard Template For Developers">
    <meta name="author" content="Xiaoying Riley at 3rd Wave Media">
    <link rel="shortcut icon" href="favicon.ico">
 <script src="https://cdn.jsdelivr.net/npm/react@16.12/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@16.12/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prop-types@15.7.2/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-apexcharts@1.3.6/dist/react-apexcharts.iife.min.js"></script>
    <!-- FontAwesome JS-->
    <script defer src="{% static 'assets/plugins/fontawesome/js/all.min.js'%}"></script>

    <!-- App CSS -->
    <link id="theme-style" rel="stylesheet" href="{% static 'assets/css/portal.css'%}">
<link href="{% static 'apex/samples/assets/styles.css'%}" rel="stylesheet" />
 <script>
  // The global window.Apex variable below can be used to set common options for all charts on the page
  Apex = {
    chart: {
      height: 160,
    },
    dataLabels: {
      enabled: false
    },
    stroke: {
      curve: 'straight'
    },
    toolbar: {
      tools: {
        selection: false
      }
    },
    markers: {
      size: 0,
      hover: {
        size: 0
      }
    },
    tooltip: {
      followCursor: false,
      theme: 'dark',
      x: {
        show: false
      },
      marker: {
        show: false
      },
      y: {
        title: {
          formatter: function() {
            return ''
          }
        }
      }
    },
    grid: {
      clipMarkers: false
    },
    yaxis: {
      tickAmount: 2
    },
    xaxis: {
      type: 'datetime'
    },
  }

  /*
    // this function will generate output in this format
    // data = [
        [timestamp, 23],
        [timestamp, 33],
        [timestamp, 12]
        ...
    ]
  */
  function generateDayWiseTimeSeries(baseval, count, yrange) {
    var i = 0;
    var series = [];
    while (i < count) {
      var x = baseval;
      var y = Math.floor(Math.random() * (yrange.max - yrange.min + 1)) + yrange.min;

      series.push([x, y]);
      baseval += 86400000;
      i++;
    }
    return series;
  }
  </script>
</head>
<style>
			.app {
			 background-image: url(../../static/bg3.jpg);
			padding: 1px;
            padding-right: 1px;
            padding-top: 44px;
            padding-left: 11px;
            padding-bottom: 11px;
            }
            .chart {
      max-width: 150%;
      margin: 1px auto;
    }
</style>
 <script>
  // RÃ©cupÃ©ration des donnÃ©es depuis Django dans le JavaScript
  var series = {
    "monthDataSeries1": {
      "Pluie": {{ data_data2}},
      "dates": {{ labels_data2|safe }},
    }
  };

  var series1 = {
    "monthDataSeries1": {
      "Pluie": {{ data_wsd}},
      "dates": {{ labels_wsd|safe }},
    }
  };

  // Maintenant, dans le React ApexChart, tu pourras utiliser 'series' et 'series1'
  // pour afficher les graphiques de tempÃ©rature et d'humiditÃ© respectivement.
</script>
 <script>
      window.Promise ||
        document.write(
          '<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"><\/script>'
        )
      window.Promise ||
        document.write(
          '<script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20171210/classList.min.js"><\/script>'
        )
      window.Promise ||
        document.write(
          '<script src="https://cdn.jsdelivr.net/npm/findindex_polyfill_mdn"><\/script>'
        )
    </script>
 <script src="https://cdn.jsdelivr.net/npm/react@16.12/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@16.12/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prop-types@15.7.2/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-apexcharts@1.3.6/dist/react-apexcharts.iife.min.js"></script>
    <script>
      // Replace Math.random() with a pseudo-random number generator to get reproducible results in e2e tests
      // Based on https://gist.github.com/blixt/f17b47c62508be59987b
      var _seed = 42;
      Math.random = function() {
        _seed = _seed * 16807 % 2147483647;
        return (_seed - 1) / 2147483646;
      };
    </script>
<body class="app">
    <header class="app-header fixed-top">
        <div class="app-header-inner">
	        <div class="container-fluid py-2">
		        <div class="app-header-content">
		            <div class="row justify-content-between align-items-center">

				    <div class="col-auto">
					    <a id="sidepanel-toggler" class="sidepanel-toggler d-inline-block d-xl-none" href="#">
						    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg>
					    </a>
				    </div><!--//col-->


		            <div class="app-utilities col-auto">


			            <div class="app-utility-item app-user-dropdown dropdown">
				            <a class="dropdown-toggle" id="user-dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false"><img src="{% static 'assets/images/user.png'%}" alt="user profile"></a>
				            <ul class="dropdown-menu" aria-labelledby="user-dropdown-toggle">
<!--								<li><a class="dropdown-item" href="account.html">Account</a></li>-->
<!--								<li><a class="dropdown-item" href="settings.html">Settings</a></li>-->
<!--								<li><hr class="dropdown-divider"></li>-->
								<li><a class="dropdown-item" href="login.html">Log Out</a></li>
							</ul>
			            </div><!--//app-user-dropdown-->
		            </div><!--//app-utilities-->
		        </div><!--//row-->
	            </div><!--//app-header-content-->
	        </div><!--//container-fluid-->
        </div><!--//app-header-inner-->
        {% include "side.html" %}
    </header><!--//app-header-->

    <div class="app-wrapper">

	    <div class="app-content pt-3 p-md-3 p-lg-4">
		    <div class="container-xl">

			    <h1 class="app-page-title">Charts</h1>

			    <div class="row g-1 mb-1">
			        <div class="col-12">
					    <div class="app-card app-card-chart h-100 shadow-sm"   >


                            <div class="app-card-body p-4">


                                <form method="GET" action="" class="mb-4 p-4 bg-light rounded shadow-sm">
  <div class="row g-3 align-items-end">

    <div class="col-md-3">
      <label for="start_date" class="form-label fw-bold">ðŸ“… Date de dÃ©but :</label>
      <input type="date" id="start_date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
    </div>

    <div class="col-md-3">
      <label for="end_date" class="form-label fw-bold">ðŸ“… Date de fin :</label>
      <input type="date" id="end_date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
    </div>

    <div class="col-md-3">
      <label for="field" class="form-label fw-bold">ðŸ”Ž Champ :</label>
      <select name="field" id="field" class="form-select">
        {% for field in available_fields %}
          <option value="{{ field }}" {% if selected_field == field %}selected{% endif %}>{{ field }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3 d-flex gap-2">
      <button type="submit" class="btn btn-primary w-50">
        <i class="bi bi-funnel-fill"></i> Filtrer
      </button>
      <a href="{% url 'tvoc7' %}" class="btn btn-secondary w-50">
        <i class="bi bi-arrow-clockwise"></i> RÃ©initialiser
      </a>
    </div>

  </div>
</form>

								<br>
								<br>
						        <div id="app" class="chart-container">
<!--									 <div id="app"></div>-->

<!--				                    <canvas id="chart-line" ></canvas>-->
<!--									 <div id="html">-->
<!--      &lt;div id=&quot;wrapper&quot;&gt;-->
<!--  &lt;div id=&quot;chart-line&quot;&gt;-->
<!--  &lt;ReactApexChart options={this.state.options} series={this.state.series} type=&quot;line&quot; height={250} /&gt;-->
<!--&lt;/div&gt;-->
<!--  &lt;div id=&quot;chart-line2&quot;&gt;-->
<!--  &lt;ReactApexChart options={this.state.optionsLine2} series={this.state.seriesLine2} type=&quot;line&quot; height={250} /&gt;-->
<!--&lt;/div&gt;-->

<!--&lt;/div&gt;-->
<!--    </div>-->

<!--						        </div>-->
					        </div><!--//app-card-body-->
				        </div><!--//app-card-->
			        </div><!--//col-->

			    </div><!--//row-->
		    </div><!--//container-fluid-->
	    </div><!--//app-content-->

	    <footer class="app-footer">

	    </footer><!--//app-footer-->

    </div><!--//app-wrapper-->


    <!-- Javascript -->
    <script src="{% static 'assets/plugins/popper.min.js'%}"></script>
    <script src="{% static 'assets/plugins/bootstrap/js/bootstrap.min.js'%}"></script>



    <!-- Charts JS -->
    <script src="{% static 'assets/plugins/chart.js/chart.min.js'%}"></script>
    <script src="{% static 'assets/js/charts-demo.js'%}"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="{% static 'dist/js/scripts.js'%}"></script>
        <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js" crossorigin="anonymous"></script>
        <script src="{% static 'assets/demo/datatables-demo.js' %}"></script>
    <!-- Page Specific JS -->
    <script src="{% static 'assets/js/app.js'%}"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<!--	<script type="text/babel">-->
<!--  class ApexChart extends React.Component {-->
<!--    constructor(props) {-->
<!--      super(props);-->

<!--      this.state = {-->
<!--        series: [{-->
<!--          name: 'Pluie',-->
<!--          data: series.monthDataSeries1.Pluie,-->
<!--        }],-->
<!--        options: {-->
<!--          chart: {-->
<!--            id: 's1',-->
<!--            type: 'line',-->
<!--            height: 200-->
<!--          },-->
<!--          labels: series.monthDataSeries1.dates,-->
<!--          xaxis: {-->
<!--            type: 'datetime',-->
<!--            labels: {-->
<!--              format: "d MMM",-->
<!--            }-->
<!--          },-->
<!--          tooltip: {-->
<!--            x: {-->
<!--              format: "dd MMM yyyy HH:mm"-->
<!--            }-->
<!--          },-->
<!--          title: {-->
<!--            text: 'Graphe PluviomÃ¨tre SenseCap',-->
<!--            align: 'left'-->
<!--          },-->
<!--          colors: ['#008FFB']-->
<!--        },-->

<!--        seriesLine2: [{-->
<!--          name: 'Pluie',-->
<!--          data: series1.monthDataSeries1.Pluie,-->
<!--        }],-->
<!--        optionsLine2: {-->
<!--          chart: {-->
<!--            id: 's2',-->
<!--            type: 'line',-->
<!--            height: 200-->
<!--          },-->
<!--          labels: series1.monthDataSeries1.dates,-->
<!--          xaxis: {-->
<!--            type: 'datetime',-->
<!--            labels: {-->
<!--              format: "d MMM",-->
<!--            }-->
<!--          },-->
<!--          tooltip: {-->
<!--            x: {-->
<!--              format: "dd MMM yyyy HH:mm"-->
<!--            }-->
<!--          },-->
<!--          title: {-->
<!--            text: 'Graphe PluviomÃ¨tre Dragino',-->
<!--            align: 'left'-->
<!--          },-->
<!--          colors: ['#546E7A']-->
<!--        },-->
<!--      };-->
<!--    }-->

<!--    render() {-->
<!--      return (-->
<!--        <div>-->
<!--          <div id="chart-line">-->
<!--            <ReactApexChart options={this.state.options} series={this.state.series} type="line" height={200} />-->
<!--          </div>-->
<!--          <div id="chart-line2">-->
<!--            <ReactApexChart options={this.state.optionsLine2} series={this.state.seriesLine2} type="line" height={200} />-->
<!--          </div>-->
<!--        </div>-->
<!--      );-->
<!--    }-->
<!--  }-->

<!--  const domContainer = document.querySelector('#app');-->
<!--  ReactDOM.render(React.createElement(ApexChart), domContainer);-->
<!--</script>-->
    <!--<script type="text/babel">-->
    <!--  class ApexChart extends React.Component {-->
    <!--    constructor(props) {-->
    <!--      super(props);-->

    <!--      this.state = {-->
    <!--        series: [-->
    <!--          {-->
    <!--            name: 'SenseCap',  // Label pour la premiÃ¨re courbe-->
    <!--            data: [-->
    <!--              {% for date, value in zipped_data2 %}-->
    <!--                { x: new Date("{{ date|escapejs }}"), y: {{ value }} },-->
    <!--              {% endfor %}-->
    <!--            ]-->
    <!--          },-->
    <!--          {-->
    <!--            name: 'Dragino',  // Label pour la deuxiÃ¨me courbe-->
    <!--            data: [-->
    <!--              {% for date, value in zipped_datawsd %}-->
    <!--                { x: new Date("{{ date|escapejs }}"), y: {{ value }} },-->
    <!--              {% endfor %}-->
    <!--            ]-->
    <!--          }-->
    <!--        ],-->
    <!--        options: {-->
    <!--          chart: {-->
    <!--            height: 350,-->
    <!--            type: 'line',-->
    <!--            dropShadow: {-->
    <!--              enabled: true,-->
    <!--              color: '#000',-->
    <!--              top: 18,-->
    <!--              left: 7,-->
    <!--              blur: 10,-->
    <!--              opacity: 0.5-->
    <!--            },-->
    <!--            zoom: {-->
    <!--              enabled: true-->
    <!--            },-->
    <!--            toolbar: {-->
    <!--              show: true-->
    <!--            }-->
    <!--          },-->
    <!--          colors: ['#000010', '#008FFF'],  // Noir pour SenseCap, Bleu pour Dragino '#008FFB', '#546E7A'-->
    <!--          dataLabels: {-->
    <!--            enabled: false,  // Active l'affichage des valeurs sur le graphique-->
    <!--          },-->
    <!--          stroke: {-->
    <!--            curve: 'smooth'  // Ajoute une courbe lissÃ©e aux lignes-->
    <!--          },-->
    <!--          title: {-->
    <!--            text: 'PluivieumÃ¨tre SenseCap et Dragino',-->
    <!--            align: 'left'-->
    <!--          },-->
    <!--          grid: {-->
    <!--            borderColor: '#e7e7e7',-->
    <!--            row: {-->
    <!--              colors: ['#f3f3f3', 'transparent'],  // Fond alternÃ© pour les lignes de la grille-->
    <!--              opacity: 0.5-->
    <!--            },-->
    <!--          },-->
    <!--          markers: {-->
    <!--            size: 0 // Taille des marqueurs pour chaque point-->
    <!--          },-->
    <!--          xaxis: {-->
    <!--            type: 'datetime',-->
    <!--            categories: [-->
    <!--              {% for date, value in zipped_data2 %}-->
    <!--                "{{ date|escapejs }}",  // Remplir avec les dates pour l'axe X-->
    <!--              {% endfor %}-->
    <!--            ],-->
    <!--            title: {-->
    <!--              text: 'Temps'-->
    <!--            }-->
    <!--          },-->
    <!--          yaxis: {-->
    <!--            title: {-->
    <!--              text: 'Valeur'-->
    <!--            },-->
    <!--            // min: 0,  // Valeur minimale de l'axe Y-->
    <!--            // max: 30  // Valeur maximale de l'axe Y-->
    <!--          },-->
    <!--          tooltip: {-->
    <!--            shared: true,  // Affiche les deux courbes au survol d'un point-->
    <!--            intersect: false,  // Permet d'afficher les valeurs des deux courbes-->
    <!--            x: {-->
    <!--              format: 'dd MMM yyyy HH:mm',  // Format de la date dans le tooltip-->
    <!--            },-->
    <!--            y: {-->
    <!--              formatter: function(value) {-->
    <!--                return value.toFixed(2);  // Afficher les valeurs avec deux dÃ©cimales-->
    <!--              }-->
    <!--            }-->
    <!--          },-->
    <!--          legend: {-->
    <!--            position: 'top',-->
    <!--            horizontalAlign: 'center',-->
    <!--            floating: true,-->
    <!--            offsetY: -25,-->
    <!--            offsetX: -5-->
    <!--          }-->
    <!--        }-->
    <!--      };-->
    <!--    }-->

    <!--    render() {-->
    <!--      return (-->
    <!--        <div id="chart-line">-->
    <!--          <ReactApexChart options={this.state.options} series={this.state.series} type="line" height={500} />-->
    <!--        </div>-->
    <!--      );-->
    <!--    }-->
    <!--  }-->

    <!--  const domContainer = document.querySelector('#app');-->
    <!--  ReactDOM.render(React.createElement(ApexChart), domContainer);-->
    <!--</script>-->
<script type="text/babel">
  class CapSolChart extends React.Component {
    constructor(props) {
      super(props);

      this.state = {
        series: [
          {% for dev_id, data in data_by_sensor.items %}
          {
            name: 'Capteur {{ dev_id }}',
            data: [
              {% for date, value in data %}
                { x: new Date("{{ date|escapejs }}"), y: {{ value|default:"null" }} },
              {% endfor %}
            ]
          },
          {% endfor %}
        ],
        options: {
          chart: {
            type: 'line',
            height: 350,
            zoom: { enabled: true }
          },
          stroke: {
            curve: 'smooth',
            connectNulls: true  // Ne pas connecter les points nuls
          },
          title: {
            text: 'Graphique des donnÃ©es des capteurs de sol ({{ selected_field }})',
            align: 'left'
          },
          xaxis: {
            type: 'datetime',
            title: { text: 'Temps' }
          },
          yaxis: {
            title: { text: '{{ selected_field }}' }
          },
          tooltip: {
            shared: true,
            intersect: false,
            x: {
              format: 'dd MMM yyyy HH:mm'
            },
            custom: function({ series, seriesIndex, dataPointIndex, w }) {
              try {
                let xVal = w.globals.seriesX[seriesIndex][dataPointIndex];

                let seriesData = w.config.series.map((serie, i) => {
                  const point = serie.data.find(p => new Date(p.x).getTime() === new Date(xVal).getTime());
                  const value = point ? point.y : null;

                  return {
                    name: serie.name,
                    value: value,
                    color: w.config.colors[i]
                  };
                });

                // Tri dÃ©croissant avec nulls Ã  la fin
                seriesData.sort((a, b) => {
                  if (b.value === null) return -1;
                  if (a.value === null) return 1;
                  return b.value - a.value;
                });

                // Construction du tooltip HTML
                let html = `<div style="padding:8px;">`;
                html += `<div style="margin-bottom:5px;"><strong>${new Date(xVal).toLocaleString()}</strong></div>`;

                seriesData.forEach(item => {
                  const displayValue = item.value !== null ? item.value.toFixed(2) : 'N/A';
                  html += `
                    <div style="display:flex; align-items:center; margin-bottom:2px;">
                      <div style="width:10px; height:10px; background:${item.color}; border-radius:50%; margin-right:5px;"></div>
                      <span>${item.name} : ${displayValue}</span>
                    </div>
                  `;
                });

                html += `</div>`;
                return html;
              } catch (error) {
                console.error("Tooltip error:", error);
                return "";
              }
            }
          },
          colors: ['#FF0000', '#00AA00', '#0000FF', '#FFA500'],
        }
      };
    }

    render() {
      return (
        <div id="chart">
          <ReactApexChart options={this.state.options} series={this.state.series} type="line" height={500} />
        </div>
      );
    }
  }

  ReactDOM.render(<CapSolChart />, document.querySelector('#app'));
</script>



</body>
</html>

